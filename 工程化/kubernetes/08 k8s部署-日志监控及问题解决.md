## 1.常见的部署方案

- 滚动更新：服务不会停止，但是整个pod会有新旧并存的情况。

- 重新创建：先停止旧的pod，然后再创建新的pod，这个过程服务是会间断的。

- 蓝绿：

  ```text
  **无需停机，风险较小**
  01-部署v1的应用（一开始的状态）
  	所有外部请求的流量都打到这个版本上.
  02-部署版本2的应用
  	版本2的代码与版本1不同(新功能、Bug修复等).
  03-将流量从版本1切换到版本2。
  04-如版本2测试正常，就删除版本1正在使用的资源（例如实例），从此正式用版本2。
  ```

- 金丝雀/灰度发布

  ```text
  灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度，而我们平常所说的金丝雀部署也就是灰度发布的一种方式
  ```


### 1.1 滚动更新

> maxSurge ：滚动升级时先启动的pod数量 
>
> maxUnavailable ：滚动升级时允许的最大unavailable的pod数量

```shell
kubectl apply -f rollingupdate.yaml
kubectl get pods
kubectl get svc
curl cluster-ip/dockerfile
```

​	rollingupdate.yaml文件如下：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollingupdate
spec:
  strategy:
    rollingUpdate:
      maxSurge: 25%		   #滚动升级时先启动的pod数量
      maxUnavailable: 25%  # 滚动升级时允许的最大unavailable的pod数量
    type: RollingUpdate    #表示滚动更新
  selector:
    matchLabels:
      app: rollingupdate
  replicas: 4
  template:
    metadata:
      labels:
        app: rollingupdate
    spec:
      containers:
      - name: rollingupdate   #下面这个image需要自己镜像仓库的版本号管理
        image: registry.cn-hangzhou.aliyuncs.com/itcrazy2016/test-docker-image:v1.0
        ports:
        - containerPort: 8080  
---
apiVersion: v1
kind: Service
metadata:
  name: rollingupdate
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: rollingupdate
  type: ClusterIP
```

**修改**rollingupdate.yaml文件，将镜像修改成**v2.0**

```shell
# 在w1上，不断地访问观察输出 
while sleep 0.2;do curl cluster-ip/dockerfile;echo "";done
# 在w2上，监控pod 
kubectl get pods -w 
# 使得更改生效 
kubectl apply -f rollingupdate.yaml

#查看下详情
kubectl get pods
kubectl get svc
```

结论：发现新旧的POD都会存在



### 1.2 重新创建

执行如下命令：

```shell
kubectl apply -f recreate.yaml
kubectl get pods

#修改recreate.yaml 镜像的版本号，然后重新执行，然后观察pod的状态，会发现先关闭后创建
kubectl apply -f recreate.yaml  
```

recreate.yaml文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recreate
spec:
  strategy: 
    type: Recreate   #表示重新创建
  selector:
    matchLabels:
      app: recreate
  replicas: 4
  template:
    metadata:
      labels:
        app: recreate
    spec:
      containers:
      - name: recreate   #主要修改下面这个镜像的版本号
        image: registry.cn-hangzhou.aliyuncs.com/itcrazy2016/test-docker-image:v1.0
        ports:
        - containerPort: 8080
        livenessProbe:
          tcpSocket:
            port: 8080
```



```shell
kubectl rollout pause deploy rollingupdate #暂停更新资源

kubectl rollout resume deploy rollingupdate  #重新启动更新资源

kubectl rollout undo deploy rollingupdate # 回到上一个版本
```



### 1.3 蓝绿





bluegreen.yaml

